<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geonature.core.gn_commons.repositories &mdash; Documentation GeoNature 2.0</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=e8570148"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../_static/translations.js?v=d99ca74e"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            GeoNature
              <img src="../../../../_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">INSTALLATION</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../CHANGELOG.html">CHANGELOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api-references.html">API REFERENCES</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Code du module</a></li>
      <li class="breadcrumb-item active">geonature.core.gn_commons.repositories</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de geonature.core.gn_commons.repositories</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="kn">import</span> <span class="n">NoResultFound</span><span class="p">,</span> <span class="n">MultipleResultsFound</span>
<span class="kn">from</span> <span class="nn">pypnnomenclature.models</span> <span class="kn">import</span> <span class="n">TNomenclatures</span>

<span class="kn">from</span> <span class="nn">geonature.core.gn_commons.models</span> <span class="kn">import</span> <span class="n">TMedias</span><span class="p">,</span> <span class="n">BibTablesLocation</span>
<span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">geonature.utils.errors</span> <span class="kn">import</span> <span class="n">GeoNatureError</span>


<div class="viewcode-block" id="TMediaRepository">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository">[docs]</a>
<span class="k">class</span> <span class="nc">TMediaRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reposity permettant de manipuler un objet média</span>
<span class="sd">    au niveau de la base de données et du système de fichier</span>
<span class="sd">    de façon synchrone</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TMediaRepository.media_data">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.media_data">[docs]</a>
    <span class="n">media_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="TMediaRepository.data">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.data">[docs]</a>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="TMediaRepository.file">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.file">[docs]</a>
    <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TMediaRepository.media">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.media">[docs]</a>
    <span class="n">media</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TMediaRepository.new">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.new">[docs]</a>
    <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_media</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_sizes</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;MEDIAS&quot;</span><span class="p">][</span><span class="s2">&quot;THUMBNAIL_SIZES&quot;</span><span class="p">]</span>
        <span class="c1"># filtrer les données du dict qui</span>
        <span class="c1"># vont être insérées dans l&#39;objet Model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TMedias</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>

        <span class="c1"># Chargement du média</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_media&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="s2">&quot;id_media&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">id_media</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_id</span><span class="p">(</span><span class="n">id_media</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">TMedias</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">)</span>

<div class="viewcode-block" id="TMediaRepository.create_or_update_media">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.create_or_update_media">[docs]</a>
    <span class="k">def</span> <span class="nf">create_or_update_media</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Création ou modification d&#39;un média :</span>
<span class="sd">         - Enregistrement en base de données</span>
<span class="sd">         - Stockage du fichier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_persist_media_db</span><span class="p">()</span>

        <span class="c1"># Si le média à un fichier associé</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;isFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="s2">&quot;media_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_file</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;media_path&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;isFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;isFile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="s2">&quot;media_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_url</span><span class="p">()</span>

        <span class="c1"># Si le média avait un fichier associé</span>
        <span class="c1"># et qu&#39;il a été remplacé par une url</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;isFile&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">move</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">remove_thumbnails</span><span class="p">()</span>

        <span class="c1"># Si le média avait une url</span>
        <span class="c1"># et qu&#39;elle a été modifiée</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;isFile&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">])</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_img</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">remove_thumbnails</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_persist_media_db</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_img</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_thumbnails</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span></div>


<div class="viewcode-block" id="TMediaRepository._persist_media_db">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository._persist_media_db">[docs]</a>
    <span class="k">def</span> <span class="nf">_persist_media_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enregistrement des données dans la base</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># @TODO récupérer les exceptions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">)</span>
            <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">media_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="c1"># @TODO A revoir avec les nouvelles contraintes</span>
            <span class="k">if</span> <span class="s2">&quot;check_entity_field_exist&quot;</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> doesn&#39;t exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;id_table_location&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="s2">&quot;fk_t_medias_check_entity_value&quot;</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;id </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> doesn&#39;t exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;id_table_location&quot;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Errors </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">))</span></div>


<div class="viewcode-block" id="TMediaRepository.absolute_file_path">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.absolute_file_path">[docs]</a>
    <span class="k">def</span> <span class="nf">absolute_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thumbnail_height</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">TMedias</span><span class="o">.</span><span class="n">base_dir</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="n">thumbnail_height</span><span class="p">))</span></div>


<div class="viewcode-block" id="TMediaRepository.test_video_link">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.test_video_link">[docs]</a>
    <span class="k">def</span> <span class="nf">test_video_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Vidéo Youtube&quot;</span> <span class="ow">and</span> <span class="s2">&quot;youtube&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">and</span> <span class="s2">&quot;youtu.be&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Vidéo Dailymotion&quot;</span> <span class="ow">and</span> <span class="s2">&quot;dailymotion&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Vidéo Vimeo&quot;</span> <span class="ow">and</span> <span class="s2">&quot;vimeo&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TMediaRepository.test_header_content_type">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.test_header_content_type">[docs]</a>
    <span class="k">def</span> <span class="nf">test_header_content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Photo&quot;</span> <span class="ow">and</span> <span class="s2">&quot;image&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Audio&quot;</span> <span class="ow">and</span> <span class="s2">&quot;audio&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Vidéo (fichier)&quot;</span> <span class="ow">and</span> <span class="s2">&quot;video&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;PDF&quot;</span> <span class="ow">and</span> <span class="s2">&quot;pdf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s2">&quot;Page web&quot;</span> <span class="ow">and</span> <span class="s2">&quot;html&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TMediaRepository.test_url">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.test_url">[docs]</a>
    <span class="k">def</span> <span class="nf">test_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">]:</span>
                <span class="k">return</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;media_url&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">GeoNatureError</span><span class="p">(</span>
                    <span class="s2">&quot;la réponse est différente de 200 (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_header_content_type</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-type&quot;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">GeoNatureError</span><span class="p">(</span>
                    <span class="s2">&quot;le format du lien (</span><span class="si">{}</span><span class="s2">) ne correspond pas au type de média choisi (</span><span class="si">{}</span><span class="s2">). Si le media est de type image essayer de récupérer l&#39;adresse de l&#39;image (clique droit sur l&#39;image : récupérer l&#39;adresse de l&#39;image)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-type&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_video_link</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">GeoNatureError</span><span class="p">(</span>
                    <span class="s2">&quot;l&#39;URL n est pas valide pour le type de média choisi (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">GeoNatureError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GeoNatureError</span><span class="p">(</span><span class="s2">&quot;Il y a un problème avec l&#39;URL renseignée : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>


<div class="viewcode-block" id="TMediaRepository.file_path">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.file_path">[docs]</a>
    <span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thumbnail_height</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_path</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_table_location</span><span class="p">),</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_media</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">thumbnail_height</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;thumbnails&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_table_location</span><span class="p">),</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_thumbnail_</span><span class="si">{}</span><span class="s2">.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_media</span><span class="p">,</span> <span class="n">thumbnail_height</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">file_path</span></div>


<div class="viewcode-block" id="TMediaRepository.upload_file">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.upload_file">[docs]</a>
    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload des fichiers sur le serveur</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># SI c&#39;est une modification =&gt;</span>
        <span class="c1">#       suppression de l&#39;ancien fichier</span>
        <span class="c1">#       suppression des thumbnails</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">remove_file</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">remove_thumbnails</span><span class="p">()</span>

        <span class="c1"># @TODO récupérer les exceptions</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_media</span><span class="p">,</span> <span class="n">secure_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">filedir</span> <span class="o">=</span> <span class="n">TMedias</span><span class="o">.</span><span class="n">base_dir</span><span class="p">()</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_table_location</span><span class="p">)</span>
        <span class="n">filedir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filedir</span> <span class="o">/</span> <span class="n">filename</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">id_table_location</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="TMediaRepository.is_img">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.is_img">[docs]</a>
    <span class="k">def</span> <span class="nf">is_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Photo&quot;</span></div>


<div class="viewcode-block" id="TMediaRepository.media_type">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.media_type">[docs]</a>
    <span class="k">def</span> <span class="nf">media_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nomenclature</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">TNomenclatures</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">TNomenclatures</span><span class="o">.</span><span class="n">id_nomenclature</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;id_nomenclature_media_type&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nomenclature</span><span class="o">.</span><span class="n">label_fr</span></div>


<div class="viewcode-block" id="TMediaRepository.get_image">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.get_image">[docs]</a>
    <span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_path</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absolute_file_path</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_url</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_url</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="TMediaRepository.has_thumbnails">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.has_thumbnails">[docs]</a>
    <span class="k">def</span> <span class="nf">has_thumbnails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test si la liste des thumbnails</span>
<span class="sd">        définis par défaut existe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">thumbnail_height</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_sizes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_thumbnail</span><span class="p">(</span><span class="n">thumbnail_height</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TMediaRepository.has_thumbnail">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.has_thumbnail">[docs]</a>
    <span class="k">def</span> <span class="nf">has_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test si le thumbnail de taille X existe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absolute_file_path</span><span class="p">(</span><span class="n">size</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TMediaRepository.create_thumbnails">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.create_thumbnails">[docs]</a>
    <span class="k">def</span> <span class="nf">create_thumbnails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creation automatique des thumbnails</span>
<span class="sd">        dont les tailles sont spécifiés dans la config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test si les thumbnails existent déjà</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_thumbnails</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">thumbnail_height</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_sizes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_thumbnail</span><span class="p">(</span><span class="n">thumbnail_height</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span></div>


<div class="viewcode-block" id="TMediaRepository.create_thumbnail">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.create_thumbnail">[docs]</a>
    <span class="k">def</span> <span class="nf">create_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image_thumb</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">image_thumb</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="n">thumb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_file_path</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">):</span>
            <span class="n">image_thumb</span> <span class="o">=</span> <span class="n">image_thumb</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="n">image_thumb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="s2">&quot;JPEG&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">thumb_path</span></div>


<div class="viewcode-block" id="TMediaRepository.get_thumbnail_url">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.get_thumbnail_url">[docs]</a>
    <span class="k">def</span> <span class="nf">get_thumbnail_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction permettant de récupérer l&#39;url d&#39;un thumbnail</span>
<span class="sd">        Si le thumbnail n&#39;existe pas il est créé à la volé</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get Thumb path and create if not exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_thumbnail</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">thumb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_thumbnail</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thumb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_file_path</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># Get relative path</span>
        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;MEDIA_FOLDER&quot;</span><span class="p">])</span>
        <span class="c1"># Get URL</span>
        <span class="n">thumb_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;media&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">relative_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thumb_url</span></div>


<div class="viewcode-block" id="TMediaRepository.delete">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository.delete">[docs]</a>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note si SQLALCHEMY_TRACK_MODIFICATIONS  = true alors suppression du fichier gérée automatiquement</span>

        <span class="c1"># Suppression du média physiquement</span>
        <span class="c1"># En réalité renommage</span>
        <span class="n">initial_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">media_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">__before_commit_delete__</span><span class="p">()</span>

        <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">)</span>
        <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="TMediaRepository._load_from_id">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediaRepository._load_from_id">[docs]</a>
    <span class="k">def</span> <span class="nf">_load_from_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_media</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Charge un média de la base à partir de son identifiant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">media</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TMedias</span><span class="p">,</span> <span class="n">id_media</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">media</span></div>
</div>



<div class="viewcode-block" id="TMediumRepository">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediumRepository">[docs]</a>
<span class="k">class</span> <span class="nc">TMediumRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe permettant de manipuler des collections</span>
<span class="sd">    d&#39;objet média</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TMediumRepository.get_medium_for_entity">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediumRepository.get_medium_for_entity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_medium_for_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_uuid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retourne la liste des médias pour un objet</span>
<span class="sd">        en fonction de son uuid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">medium</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">TMedias</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TMedias</span><span class="o">.</span><span class="n">uuid_attached_row</span> <span class="o">==</span> <span class="n">entity_uuid</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">medium</span></div>


    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TMediumRepository.sync_medias">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.TMediumRepository.sync_medias">[docs]</a>
    <span class="k">def</span> <span class="nf">sync_medias</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Met à jour les médias</span>
<span class="sd">          - supprime les médias sans uuid_attached_row plus vieux que 24h</span>
<span class="sd">          - supprime les médias dont l&#39;object attaché n&#39;existe plus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># delete media temp &gt; 24h</span>
        <span class="n">res_medias_temp</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">TMedias</span><span class="o">.</span><span class="n">id_media</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">and_</span><span class="p">(</span>
                    <span class="n">TMedias</span><span class="o">.</span><span class="n">meta_update_date</span>
                    <span class="o">&lt;</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)),</span>
                    <span class="n">TMedias</span><span class="o">.</span><span class="n">uuid_attached_row</span> <span class="o">==</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">id_medias_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">id_media</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">res_medias_temp</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">id_medias_temp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sync media remove temp media with ids : &quot;</span><span class="p">,</span> <span class="n">id_medias_temp</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">id_media</span> <span class="ow">in</span> <span class="n">id_medias_temp</span><span class="p">:</span>
            <span class="n">TMediaRepository</span><span class="p">(</span><span class="n">id_media</span><span class="o">=</span><span class="n">id_media</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># SYNCRONISATION media - fichiers</span>

        <span class="c1"># liste des id des medias fichiers</span>
        <span class="n">liste_fichiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">search_path</span> <span class="o">=</span> <span class="n">TMedias</span><span class="o">.</span><span class="n">base_dir</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">repertoire</span><span class="p">,</span> <span class="n">sous_repertoires</span><span class="p">,</span> <span class="n">fichiers</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">search_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fichiers</span><span class="p">:</span>
                <span class="n">id_media</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">id_media</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">id_media</span><span class="p">)</span>
                    <span class="n">f_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id_media&quot;</span><span class="p">:</span> <span class="n">id_media</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">repertoire</span><span class="p">,</span> <span class="n">f</span><span class="p">)}</span>
                    <span class="n">liste_fichiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># liste des media fichier supprimés en base</span>
        <span class="n">ids_media_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;id_media&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">liste_fichiers</span><span class="p">]</span>
        <span class="n">ids_media_file</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">ids_media_file</span><span class="p">))</span>

        <span class="c1"># suppression des fichiers dont le media n&#39;existe plpus en base</span>
        <span class="n">ids_media_base</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">TMedias</span><span class="o">.</span><span class="n">id_media</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TMedias</span><span class="o">.</span><span class="n">id_media</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids_media_file</span><span class="p">))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">ids_media_base</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ids_media_base</span><span class="p">]</span>

        <span class="n">ids_media_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ids_media_file</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids_media_base</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ids_media_to_delete</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sync media remove unassociated medias with ids : &quot;</span><span class="p">,</span> <span class="n">ids_media_to_delete</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f_data</span> <span class="ow">in</span> <span class="n">liste_fichiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f_data</span><span class="p">[</span><span class="s2">&quot;id_media&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids_media_to_delete</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;thumbnail&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">f_data</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f_data</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f_data</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                <span class="n">p</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;deleted_</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="get_table_location_id">
<a class="viewcode-back" href="../../../../autoapi/geonature/core/gn_commons/repositories/index.html#geonature.core.gn_commons.repositories.get_table_location_id">[docs]</a>
<span class="k">def</span> <span class="nf">get_table_location_id</span><span class="p">(</span><span class="n">schema_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">BibTablesLocation</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BibTablesLocation</span><span class="o">.</span><span class="n">schema_name</span> <span class="o">==</span> <span class="n">schema_name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BibTablesLocation</span><span class="o">.</span><span class="n">table_name</span> <span class="o">==</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">MultipleResultsFound</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GeoNatureError</span><span class="p">(</span>
            <span class="s2">&quot;get_table_location_id : Table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> à de multiples entrées dans BibTablesLocation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">schema_name</span><span class="p">,</span> <span class="n">table_name</span>
            <span class="p">)</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">MultipleResultsFound</span>
    <span class="k">return</span> <span class="n">location</span><span class="o">.</span><span class="n">id_table_location</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2018-2023, PnE, PnC.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>