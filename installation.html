<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INSTALLATION &mdash; Documentation GeoNature 2.0</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=e8570148"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/translations.js?v=d99ca74e"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="MANUEL UTILISATEUR" href="user-manual.html" />
    <link rel="prev" title="Bienvenue dans la documentation de GeoNature" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="index.html" class="icon icon-home">
            GeoNature
              <img src="_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">INSTALLATION</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequis">Prérequis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation-du-serveur">Préparation du serveur</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation-globale">Installation globale</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation-des-applications">Installation des applications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installation-de-geonature-uniquement">Installation de GeoNature uniquement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation-des-dependances">Installation des dépendances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recuperation-de-l-application">Récupération de l’application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation-de-l-application">Installation de l’application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-apache">Configuration Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependances">Dépendances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#passer-en-mode-developpement">Passer en mode développement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#docker">Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker-compose">Docker Compose</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-backend">Image backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-frontend">Image frontend</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#https">HTTPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installer-certbot">Installer certbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lancer-la-commande-cerbot">Lancer la commande cerbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prise-en-compte-des-nouvelles-configurations-apache">Prise en compte des nouvelles configurations Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-de-l-application-geonature">Configuration de l’application GeoNature</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#taches-planifiees">Taches planifiées</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation-d-un-module-geonature">Installation d’un module GeoNature</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#telechargement">Téléchargement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation-automatique">Installation automatique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation-manuelle">Installation manuelle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-du-module">Configuration du module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mise-a-jour-du-module">Mise à jour du module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mise-a-jour-de-l-application">Mise à jour de l’application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html#tests-backend">Tests backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-references.html">API REFERENCES</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">INSTALLATION</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/installation.rst.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation">
<h1>INSTALLATION<a class="headerlink" href="#installation" title="Link to this heading"></a></h1>
<p>GeoNature repose sur les composants suivants :</p>
<ul class="simple">
<li><p>PostgreSQL / PostGIS</p></li>
<li><p>Python 3 et dépendances Python nécessaires à l’application</p></li>
<li><p>Flask (framework web Python)</p></li>
<li><p>Apache</p></li>
<li><p>Angular 15, Angular CLI, NodeJS</p></li>
<li><p>Librairies javascript (Leaflet, ChartJS)</p></li>
<li><p>Librairies CSS (Bootstrap, Material Design)</p></li>
</ul>
<p>Deux méthodes d’installation existent :</p>
<ul class="simple">
<li><p><a class="reference internal" href="#installation-all"><span class="std std-ref">Installation globale</span></a> : Installation automatisée de GeoNature, TaxHub et UsersHub.</p></li>
<li><p><a class="reference internal" href="#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a> : TaxHub et UsersHub ne sont pas installés (mais leurs schémas sont tous de même créés dans la base de données).</p></li>
</ul>
<section id="prerequis">
<h2>Prérequis<a class="headerlink" href="#prerequis" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Ressources minimum serveur :</p>
<ul>
<li><p>Un serveur Debian 11 ou 12, architecture 64-bits</p></li>
<li><p>4 Go RAM</p></li>
<li><p>20 Go d’espace disque</p></li>
</ul>
</li>
<li><p>GeoNature nécessite d’accéder à des ressources externes durant son installation et son fonctionnement. Si vous utilisez un serveur mandataire, celui-ci doit permettre l’accès aux domaines suivants :</p>
<ul>
<li><p><a class="reference external" href="https://pypi.python.org">https://pypi.python.org</a></p></li>
<li><p><a class="reference external" href="https://geonature.fr/">https://geonature.fr/</a></p></li>
<li><p><a class="reference external" href="https://codeload.github.com/">https://codeload.github.com/</a></p></li>
<li><p><a class="reference external" href="https://nodejs.org/dist">https://nodejs.org/dist</a></p></li>
<li><p><a class="reference external" href="https://registry.npmjs.org">https://registry.npmjs.org</a></p></li>
<li><p><a class="reference external" href="https://www.npmjs.com">https://www.npmjs.com</a></p></li>
<li><p><a class="reference external" href="https://raw.githubusercontent.com/">https://raw.githubusercontent.com/</a></p></li>
<li><p><a class="reference external" href="https://data.geopf.fr/">https://data.geopf.fr/</a></p></li>
</ul>
</li>
</ul>
</section>
<section id="preparation-du-serveur">
<span id="preparation-server"></span><h2>Préparation du serveur<a class="headerlink" href="#preparation-du-serveur" title="Link to this heading"></a></h2>
<p>Commencer la procédure en se connectant au serveur en SSH avec l’utilisateur linux <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<ul>
<li><p>Mettre à jour de la liste des dépôts Linux :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>update
<span class="gp"># </span>apt<span class="w"> </span>upgrade
</pre></div>
</div>
</li>
<li><p>Configuration de la locale du serveur</p>
<p>Certains serveurs sont livrés sans « locale » (langue par défaut). Pour l’installation de GeoNature, il est nécessaire de bien configurer la locale. Si la commande <code class="docutils literal notranslate"><span class="pre">locale</span></code> renvoie ceci :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">LANG=fr_FR.UTF-8</span>
<span class="go">LANGUAGE=fr_FR.UTF-8</span>
<span class="go">LC_CTYPE=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_NUMERIC=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_TIME=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_COLLATE=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_MONETARY=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_MESSAGES=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_PAPER=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_NAME=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_ADDRESS=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_TELEPHONE=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_MEASUREMENT=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_IDENTIFICATION=&quot;fr_FR.UTF-8&quot;</span>
<span class="go">LC_ALL=fr_FR.UTF-8</span>
</pre></div>
</div>
<p>Vous pouvez alors passer cette étape de configuration des locales.</p>
<p>Sinon exécuter la commande <code class="docutils literal notranslate"><span class="pre">dpkg-reconfigure</span> <span class="pre">locales</span></code>. Une fenêtre s’affiche dans votre console. Dans la liste déroulante, sélectionnez <code class="docutils literal notranslate"><span class="pre">fr_FR.UTF-8</span> <span class="pre">UTF-8</span></code> avec <code class="docutils literal notranslate"><span class="pre">Espace</span></code>, puis cliquez sur OK. Une 2ème fenêtre s’affiche avec une liste de locale activées (<code class="docutils literal notranslate"><span class="pre">fr_FR.UTF-8</span></code> doit être présent dans la liste), confirmez votre choix, en cliquant sur OK, puis attendez que la locale s’installe.</p>
</li>
<li><p>Installer l’utilitaire <code class="docutils literal notranslate"><span class="pre">sudo</span></code> :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>sudo
</pre></div>
</div>
</li>
<li><p>Créer un utilisateur Linux dédié (nommé <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code> dans notre cas) pour ne pas travailler en <code class="docutils literal notranslate"><span class="pre">root</span></code> :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>adduser<span class="w"> </span>geonatureadmin
</pre></div>
</div>
</li>
<li><p>Lui donner ensuite les droits administrateur en l’ajoutant au groupe <code class="docutils literal notranslate"><span class="pre">sudo</span></code> :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>adduser<span class="w"> </span>geonatureadmin<span class="w"> </span>sudo
</pre></div>
</div>
</li>
<li><p>Pour la suite du processus d’installation, on utilisera l’utilisateur non privilégié nouvellement créé. Si besoin d’éxecuter des commandes avec les droits d’administrateur, on les précèdera de <code class="docutils literal notranslate"><span class="pre">sudo</span></code>.</p>
<p>Il est d’ailleurs possible renforcer la sécurité du serveur en bloquant la connexion SSH au serveur avec <code class="docutils literal notranslate"><span class="pre">root</span></code>. Voir <a class="reference external" href="https://docs.ovh.com/fr/vps/conseils-securisation-vps/">https://docs.ovh.com/fr/vps/conseils-securisation-vps/</a> pour plus d’informations sur le sécurisation du serveur.</p>
<p>Pour passer de l’utilisateur <code class="docutils literal notranslate"><span class="pre">root</span></code> à <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code>, vous pouvez aussi utiliser la commande :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>su<span class="w"> </span>-<span class="w"> </span>geonatureadmin
</pre></div>
</div>
</li>
</ul>
</section>
<section id="installation-globale">
<span id="installation-all"></span><h2>Installation globale<a class="headerlink" href="#installation-globale" title="Link to this heading"></a></h2>
<p>Ce document décrit une procédure d’installation packagée de GeoNature.</p>
<p>En lançant le script d’installation ci-dessous, l’application GeoNature ainsi que ses dépendances seront installées sur un seul et même serveur au sein d’une seule base de données.</p>
<p>Les applications suivantes seront installées :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PnX-SI/GeoNature">GeoNature</a></p></li>
<li><p><a class="reference external" href="https://github.com/PnX-SI/TaxHub">TaxHub</a> qui pilote le schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code></p></li>
<li><p><a class="reference external" href="https://github.com/PnX-SI/UsersHub">UsersHub</a> qui pilote le schéma <code class="docutils literal notranslate"><span class="pre">utilisateurs</span></code> (le paramètre <code class="docutils literal notranslate"><span class="pre">install_usershub_app</span></code> du fichier de configuration <code class="docutils literal notranslate"><span class="pre">install_all.ini</span></code> permet de désactiver l’installation de l’application. Il est cependant recommandé d’installer l’application pour disposer d’une interface pour gérer les utilisateurs dans GeoNature)</p></li>
</ul>
<p>Si vous disposez déjà de Taxhub ou de UsersHub sur un autre serveur ou une autre base de données et que vous souhaitez installer simplement GeoNature, veuillez suivre la documentation <a class="reference internal" href="#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a>.</p>
<section id="installation-des-applications">
<h3>Installation des applications<a class="headerlink" href="#installation-des-applications" title="Link to this heading"></a></h3>
<p>Commencer la procédure en se connectant au serveur en SSH avec l’utilisateur dédié précédemment créé lors de l’étape de <a class="reference internal" href="#preparation-server"><span class="std std-ref">Préparation du serveur</span></a> (usuellement <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code>).</p>
<ul>
<li><p>Se placer à la racine du <code class="docutils literal notranslate"><span class="pre">home</span></code> de l’utilisateur puis récupérer les scripts d’installation (X.Y.Z à remplacer par le numéro de la <a class="reference external" href="https://github.com/PnEcrins/GeoNature/releases">dernière version stable de GeoNature</a>). Ces scripts installent les applications GeoNature, TaxHub et UsersHub (en option) ainsi que leurs bases de données (uniquement les schémas du coeur) :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>https://raw.githubusercontent.com/PnX-SI/GeoNature/X.Y.Z/install/install_all/install_all.ini
<span class="gp">$ </span>wget<span class="w"> </span>https://raw.githubusercontent.com/PnX-SI/GeoNature/X.Y.Z/install/install_all/install_all.sh
</pre></div>
</div>
</li>
</ul>
<p><em>Attention</em> : l’installation globale fonctionne uniquement si les scripts sont placés à la racine du <code class="docutils literal notranslate"><span class="pre">home</span></code> de l’utilisateur courant.</p>
<ul>
<li><p>Configurez votre installation en adaptant le fichier <code class="docutils literal notranslate"><span class="pre">install_all.ini</span></code> :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nano<span class="w"> </span>install_all.ini
</pre></div>
</div>
</li>
</ul>
<p>Renseignez à minima votre utilisateur linux, l’URL (ou IP) de votre serveur (avec un <code class="docutils literal notranslate"><span class="pre">/</span></code> à la fin) ainsi que l’utilisateur PostgreSQL que vous souhaitez et son mot de passe. Le script se chargera d’installer PostgreSQL et de créer l’utilisateur de base de données que vous avez renseigné. Pour une installation de développement, pensez à renseigner <code class="docutils literal notranslate"><span class="pre">mode=dev</span></code>.</p>
<p>Il est déconseillé de modifier les numéros de version des dépendances, chaque nouvelle version de GeoNature étant fournie avec les versions adaptées de ses dépendances.</p>
<ul>
<li><p>Lancer l’installation :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>touch<span class="w"> </span>install_all.log
<span class="gp">$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>install_all.sh
<span class="gp">$ </span>./install_all.sh<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>install_all.log
</pre></div>
</div>
</li>
</ul>
<p>Une fois l’installation terminée, lancez la commande suivante:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">exec</span><span class="w"> </span>bash
</pre></div>
</div>
</div></blockquote>
<p>Les applications sont disponibles aux adresses suivantes :</p>
<ul class="simple">
<li><p><a class="reference external" href="http://monip.com/geonature/">http://monip.com/geonature/</a></p></li>
<li><p><a class="reference external" href="http://monip.com/taxhub/">http://monip.com/taxhub/</a></p></li>
<li><p><a class="reference external" href="http://monip.com/usershub/">http://monip.com/usershub/</a> (en option)</p></li>
</ul>
<p>Vous pouvez vous connecter avec l’utilisateur intégré par défaut (admin/admin).</p>
<dl class="field-list simple">
<dt class="field-odd">Note<span class="colon">:</span></dt>
<dd class="field-odd"><p>Pour en savoir plus TaxHub, sa configuration et son utilisation, reportez-vous à sa documentation : <a class="reference external" href="https://taxhub.readthedocs.io">https://taxhub.readthedocs.io</a>. Idem pour UsersHub et sa documentation : <a class="reference external" href="https://usershub.readthedocs.io">https://usershub.readthedocs.io</a></p>
</dd>
<dt class="field-even">Note<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>GeoNature-atlas compatible avec GeoNature V2 est disponible sur <a class="reference external" href="https://github.com/PnX-SI/GeoNature-atlas">https://github.com/PnX-SI/GeoNature-atlas</a></p></li>
<li><p>Vous pouvez utiliser le schéma <code class="docutils literal notranslate"><span class="pre">ref_geo</span></code> de GeoNature pour votre territoire, les communes et les mailles.</p></li>
</ul>
</dd>
</dl>
<p>Si vous rencontrez une erreur, se reporter aux fichiers de logs <code class="docutils literal notranslate"><span class="pre">/home/`whoami`/install_all.log</span></code>.</p>
<dl class="field-list">
<dt class="field-odd">Note<span class="colon">:</span></dt>
<dd class="field-odd"><p>Si vous souhaitez que GeoNature soit à la racine du serveur, ou à une autre adresse, editez le fichier de configuration Apache (<code class="docutils literal notranslate"><span class="pre">/etc/apache2/sites-available/geonature.conf</span></code>) en modifiant l’alias :</p>
<ul class="simple">
<li><p>Pour <code class="docutils literal notranslate"><span class="pre">/</span></code>: <code class="docutils literal notranslate"><span class="pre">Alias</span> <span class="pre">/</span> <span class="pre">/home/test/geonature/frontend/dist</span></code></p></li>
<li><p>Pour <code class="docutils literal notranslate"><span class="pre">/saisie</span></code> : <code class="docutils literal notranslate"><span class="pre">Alias</span> <span class="pre">/saisie</span> <span class="pre">/home/test/geonature/frontend/dist</span></code></p></li>
</ul>
</dd>
<dt class="field-even">Note<span class="colon">:</span></dt>
<dd class="field-even"><p>Par défaut et par mesure de sécurité, la base de données est accessible uniquement localement par la machine où elle est installée. Pour accéder à la BDD depuis une autre machine (pour s’y connecter avec QGIS, pgAdmin ou autre), vous pouvez consulter cette documentation <a class="reference external" href="https://github.com/PnX-SI/Ressources-techniques/blob/master/PostgreSQL/acces-bdd.rst">https://github.com/PnX-SI/Ressources-techniques/blob/master/PostgreSQL/acces-bdd.rst</a>.
Attention, exposer la base de données sur internet n’est pas recommandé. Il est préférable de se connecter via un tunnel SSH. QGIS et la plupart des outils d’administration de base de données permettent d’établir une connexion à la base de cette manière.
Attention si vous redémarrez PostgreSQL (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">postgresql</span> <span class="pre">restart</span></code>), il faut ensuite redémarrer les API de GeoNature, UsersHub et TaxHub :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>geonature
<span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>geonature-worker
<span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>usershub
<span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>taxhub
</pre></div>
</div>
</dd>
<dt class="field-odd">Note<span class="colon">:</span></dt>
<dd class="field-odd"><p>Il est aussi important de configurer l’accès au serveur en HTTPS plutôt qu’en HTTP pour chiffrer le contenu des échanges entre le navigateur et le serveur (<a class="reference external" href="https://docs.ovh.com/fr/hosting/les-certificats-ssl-sur-les-hebergements-web/">https://docs.ovh.com/fr/hosting/les-certificats-ssl-sur-les-hebergements-web/</a>).</p>
</dd>
</dl>
</section>
</section>
<section id="installation-de-geonature-uniquement">
<span id="installation-standalone"></span><h2>Installation de GeoNature uniquement<a class="headerlink" href="#installation-de-geonature-uniquement" title="Link to this heading"></a></h2>
<p>Cette procédure détail l’installation de GeoNature seul, sans TaxHub et UsersHub.
Si vous souhaitez installer GeoNature avec TaxHub et UsersHub, reportez-vous à la section <a class="reference internal" href="#installation-all"><span class="std std-ref">Installation globale</span></a>.</p>
<section id="installation-des-dependances">
<h3>Installation des dépendances<a class="headerlink" href="#installation-des-dependances" title="Link to this heading"></a></h3>
<p>Installer les paquets suivants :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install unzip git postgresql-postgis postgis python3-pip python3-venv python3-dev libpq-dev libgdal-dev libffi-dev libpangocairo-1.0-0 apache2 redis
</pre></div>
</div>
</section>
<section id="recuperation-de-l-application">
<h3>Récupération de l’application<a class="headerlink" href="#recuperation-de-l-application" title="Link to this heading"></a></h3>
<ul>
<li><p>Se placer dans le répertoire de l’utilisateur (<code class="docutils literal notranslate"><span class="pre">/home/geonatureadmin/</span></code> dans notre cas)</p></li>
<li><p>Récupérer l’application (<code class="docutils literal notranslate"><span class="pre">X.Y.Z</span></code> à remplacer par le numéro de la <a class="reference external" href="https://github.com/PnEcrins/GeoNature/releases">dernière version stable de GeoNature</a>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://github.com/PnX-SI/GeoNature/archive/X.Y.Z.zip
</pre></div>
</div>
</li>
<li><p>Dézipper l’archive de l’application</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ unzip X.Y.Z.zip
$ rm X.Y.Z.zip
</pre></div>
</div>
</li>
<li><p>Renommer le répertoire de l’application puis placez-vous dedans :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mv GeoNature-X.Y.Z /home/`whoami`/geonature/
$ cd geonature
</pre></div>
</div>
</li>
<li><p>Copier puis mettre à jour le fichier de configuration (<code class="docutils literal notranslate"><span class="pre">config/settings.ini</span></code>) comportant les informations relatives à votre environnement serveur :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cp config/settings.ini.sample config/settings.ini
$ nano config/settings.ini
</pre></div>
</div>
</li>
</ul>
</section>
<section id="installation-de-l-application">
<h3>Installation de l’application<a class="headerlink" href="#installation-de-l-application" title="Link to this heading"></a></h3>
<p>Rendez vous dans le dossier <code class="docutils literal notranslate"><span class="pre">install</span></code> et lancez successivement dans l’ordre les scripts suivants :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">01_install_backend.sh</span></code> : Création du virtualenv python, installation des dépendances et du backend de GeoNature dans celui-ci.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">02_configure_systemd.sh</span></code> : Création des services systemd <code class="docutils literal notranslate"><span class="pre">geonature</span></code> et <code class="docutils literal notranslate"><span class="pre">geonature-worker</span></code>, configuration de <code class="docutils literal notranslate"><span class="pre">logrotate</span></code>, création des dossiers <code class="docutils literal notranslate"><span class="pre">/run/geonature</span></code> et <code class="docutils literal notranslate"><span class="pre">/var/log/geonature</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">03_create_db.sh</span></code> : Création du role PostgreSQL, de la base de données, ajout des extensions nécessaires (PostGIS, …), création des schémas nécessaires à GeoNature et ajout des données métiers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">04_install_gn_modules.sh</span></code> : Installation des modules Occtax, Occhab et Validation (si activé dans le fichier <cite>settings.ini</cite>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">05_install_frontend.sh</span></code> : Création des dossiers et liens symboliques nécessaires, création des fichiers custom à partir des fichiers d’exemple, génération des fichiers de configuration grâce à la commande <code class="docutils literal notranslate"><span class="pre">geonature</span></code>, installation de nvm, npm et node ainsi que toutes les dépendances javascript nécessaires puis build du frontend, génération du fichier <code class="docutils literal notranslate"><span class="pre">src/assets/config.json</span></code> qui permet de connecter le frontend au backend.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">06_configure_apache.sh</span></code> : Installation du fichier de configuration Apache <code class="docutils literal notranslate"><span class="pre">/etc/apache2/conf-available/geonature.conf</span></code> et activation des modules Apache nécessaires.</p></li>
</ul>
<p>Vous pouvez alors démarrer le backend de GeoNature : <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">geonature</span></code></p>
</section>
<section id="configuration-apache">
<h3>Configuration Apache<a class="headerlink" href="#configuration-apache" title="Link to this heading"></a></h3>
<ul>
<li><p>Le script <code class="docutils literal notranslate"><span class="pre">install/06_configure_apache.sh</span></code> copie le fichier de configuration de référence <code class="docutils literal notranslate"><span class="pre">install/assets/geonature_apache.conf</span></code>, le place dans <code class="docutils literal notranslate"><span class="pre">/etc/apache2/conf-available/geonature.conf</span></code> et remplace ses variables à partir de votre configuration de GeoNature.</p>
<p>Relancez ce script si vous changez l’URL de votre GeoNature ou les paramètres liés aux chemins et URL des fichiers statiques et des médias.</p>
</li>
<li><p>Créez la configuration du vhost, incluant la configuration par défaut créée précédemment :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>install/assets/vhost_apache.conf<span class="w"> </span>/etc/apache2/sites-available/geonature.conf<span class="w"> </span><span class="c1"># Copier le vhost</span>
<span class="gp">$ </span>sudo<span class="w"> </span>nano<span class="w"> </span>/etc/apache2/sites-available/geonature.conf<span class="w"> </span><span class="c1"># Modifier la variable ``${DOMAIN_NAME}``</span>
</pre></div>
</div>
</li>
<li><p>Activez la nouvelle configuration :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>a2ensite<span class="w"> </span>geonature.conf
</pre></div>
</div>
</li>
<li><p>et redémarrez Apache :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>apache2
</pre></div>
</div>
</li>
<li><p>L’application est disponible à l’adresse suivante : <a class="reference external" href="http://monurl.fr/geonature">http://monurl.fr/geonature</a></p></li>
</ul>
<p>Une page HTML de maintenance et un vhost dédié sont aussi disponibles. Pour les mettre en place :</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>install/assets/vhost_apache_maintenance.conf<span class="w"> </span>/etc/apache2/sites-available/geonature_maintenance.conf<span class="w"> </span><span class="c1"># Copier le vhost</span>
<span class="gp">$ </span>sudo<span class="w"> </span>nano<span class="w"> </span>/etc/apache2/sites-available/geonature_maintenance.conf<span class="w"> </span><span class="c1"># Modifier la variable ``${DOMAIN_NAME}``</span>
<span class="gp">$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>install/assets/maintenance.html<span class="w"> </span>/var/www/geonature_maintenance/index.html
</pre></div>
</div>
</div></blockquote>
<p>Pour passer votre GeoNature en maintenance, vous pouvez alors désactiver le vhost de GeoNature et activer celui de la page de maintenance :</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>a2dissite<span class="w"> </span>geonature.conf
<span class="gp">$ </span>sudo<span class="w"> </span>a2ensite<span class="w"> </span>geonature_maintenance.conf
</pre></div>
</div>
</div></blockquote>
</section>
<section id="dependances">
<h3>Dépendances<a class="headerlink" href="#dependances" title="Link to this heading"></a></h3>
<p>Lors de l’installation de la BDD (<code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code>), le schéma <code class="docutils literal notranslate"><span class="pre">utilisateurs</span></code> de UsersHub et le schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code> de TaxHub sont intégrés automatiquement dans la BDD de GeoNature.</p>
<p>UsersHub n’est pas nécessaire au fonctionnement de GeoNature mais il sera utile pour avoir une interface de gestion des utilisateurs, des groupes et de leurs droits.</p>
<p>Par contre il est nécessaire d’installer TaxHub (<a class="reference external" href="https://github.com/PnX-SI/TaxHub">https://github.com/PnX-SI/TaxHub</a>) pour que GeoNature fonctionne. En effet, GeoNature utilise l’API de TaxHub. Une fois GeoNature installé, il vous faut donc installer TaxHub en le connectant à la BDD de GeoNature, vu que son schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code> a déjà été installé par le script <code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code> de GeoNature. Lors de l’installation de TaxHub, n’installez donc que l’application et pas la BDD.</p>
<p>Télécharger TaxHub depuis son dépôt Github depuis la racine de votre utilisateur :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">TaxHub</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">rm</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
<p>en mode développeur:</p>
<p><code class="docutils literal notranslate"><span class="pre">https://github.com/PnX-SI/TaxHub.git</span></code></p>
<p>Rendez vous dans le répertoire téléchargé et dézippé, puis « désamplez » le fichier <code class="docutils literal notranslate"><span class="pre">settings.ini</span></code> et remplissez la configuration avec les paramètres de connexion à la BDD GeoNature précedemment installée :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">sample</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span>
<span class="n">nano</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Lancer le script d’installation de l’application :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">install_app</span><span class="o">.</span><span class="n">sh</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">install_app</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Suite à l’execution de ce script, l’application Taxhub a été lancée automatiquement par le superviseur et est disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">http://127.0.0.1:5000</span></code> (et l’API, à <code class="docutils literal notranslate"><span class="pre">http://127.0.0.1:5000/api</span></code>)</p>
<p>Voir la doc d’installation de TaxHub : <a class="reference external" href="https://taxhub.readthedocs.io/">https://taxhub.readthedocs.io/</a></p>
<p>Voir la doc d’installation de UsersHub : <a class="reference external" href="https://usershub.readthedocs.io/">https://usershub.readthedocs.io/</a></p>
</section>
<section id="passer-en-mode-developpement">
<h3>Passer en mode développement<a class="headerlink" href="#passer-en-mode-developpement" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Consultez le guide <a class="reference internal" href="development.html#mode-dev"><span class="std std-ref">Passer en mode développement</span></a> de GeoNature.</p>
</div>
</section>
</section>
<section id="docker">
<h2>Docker<a class="headerlink" href="#docker" title="Link to this heading"></a></h2>
<p>L’installation de GeoNature avec Docker est la manière la plus simple de déployer GeoNature, ses 4 modules externes principaux (Import, Export, Dashboard, Monitoring), TaxHub et UsersHub, mais aussi de les mettre à jour, avec seulement quelques lignes de commandes.</p>
<p>Elle permet aussi d’installer GeoNature sur différents systèmes, et pas uniquement sur Debian, comme c’est le cas avec l’installation classique.</p>
<p>Elle peut néanmoins nécessiter de connaitre le fonctionnement de Docker pour ceux qui souhaitent aller plus loin et mettre en place une installation plus spécifique.</p>
<section id="docker-compose">
<h3>Docker Compose<a class="headerlink" href="#docker-compose" title="Link to this heading"></a></h3>
<p>Pour déployer facilement GeoNature avec Docker, utilisez le Docker Compose proposé et documenté dans le dépôt <a class="reference external" href="https://github.com/PnX-SI/Geonature-Docker-services/">GeoNature-Docker-services</a>.</p>
<p>Pour des déploiements Docker plus avancés et spécifiques, des images Docker des différents outils (GeoNature, TaxHub, UsersHub, GeoNature et ses 4 modules externes principaux) sont automatiquement construites et publiées à chaque nouvelle version publiée.</p>
</section>
<section id="image-backend">
<h3>Image backend<a class="headerlink" href="#image-backend" title="Link to this heading"></a></h3>
<p>Des images pré-construites automatiquement sont présentes sur <a class="reference external" href="https://github.com/PnX-SI/GeoNature/pkgs/container/geonature-backend/versions?filters%5Bversion_type%5D=tagged">Github</a>.</p>
<p>Les images tagguées <cite>-wheels</cite> contiennent les wheels Python de GeoNature, de ses dépendances et modules contrib, de manière à pouvoir être enrichies avec vos wheels provenant de vos propres modules (images de type « builder »).</p>
<p>Construction manuelle de l’image :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-f<span class="w"> </span>backend/Dockerfile<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--target<span class="o">=</span>prod<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--tag<span class="o">=</span>ghcr.io/pnx-si/geonature-backend:develop
</pre></div>
</div>
<p>Fonctionnement de l’image :</p>
<ul class="simple">
<li><p>GeoNature attend sa configuration dans le dossier <code class="docutils literal notranslate"><span class="pre">/dist/config</span></code> (à monter dans un volume afin de pouvoir la modifier).
L’emplacement du fichier de configuration peut également être précisé via la variable d’environnement <code class="docutils literal notranslate"><span class="pre">GEONATURE_CONFIG_FILE</span></code>.</p></li>
<li><p>Il est également possible de fournir une configuration Python via la variable d’environnement <code class="docutils literal notranslate"><span class="pre">GEONATURE_SETTINGS</span></code>.</p></li>
<li><p>Les médias seront stockés dans le dossier <code class="docutils literal notranslate"><span class="pre">/dist/media</span></code> (à monter dans un volume afin de les sauvegarder).</p></li>
<li><p>Toute variable d’environnement préfixée par <code class="docutils literal notranslate"><span class="pre">GEONATURE_</span></code> se verra traduite par un paramètre de configuration homonyme
(<a class="reference external" href="https://flask.palletsprojects.com/en/2.2.x/api/#flask.Config.from_prefixed_env">documentation Flask</a>).
Si vous souhaitez définir une variable de configuration se trouvant dans une section, utilisez deux <em>underscore</em>.
Par exemple, pour définir le paramètre <code class="docutils literal notranslate"><span class="pre">NB_LAST_OBS</span></code> de la section <code class="docutils literal notranslate"><span class="pre">[SYNTHESE]</span></code>, on définira une variable d’environnement <code class="docutils literal notranslate"><span class="pre">GEONATURE_SYNTHESE__NB_LAST_OBS</span></code>.</p></li>
<li><p>Pour peupler la base de données, référez-vous au script <code class="docutils literal notranslate"><span class="pre">install/03_create_db.sh</span></code>.</p></li>
</ul>
</section>
<section id="image-frontend">
<h3>Image frontend<a class="headerlink" href="#image-frontend" title="Link to this heading"></a></h3>
<p>Des images pré-construites automatiquement sont présentes sur <a class="reference external" href="https://github.com/PnX-SI/GeoNature/pkgs/container/geonature-frontend/versions?filters%5Bversion_type%5D=tagged">Github</a>.</p>
<p>Les images tagguées <cite>-source</cite> contiennent uniquement les sources de GeoNature et des modules contrib, et attendent d’être enrichies avec les sources de vos propres modules tandis que les images tagguées <cite>-nginx</cite> contiennent la configuration NGINX prête à l’emploi pour GeoNature (images de type « builder »).</p>
<p>Construction manuelle de l’image :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-f<span class="w"> </span>frontend/Dockerfile<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--target<span class="o">=</span>prod<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--tag<span class="o">=</span>ghcr.io/pnx-si/geonature-frontend:develop
</pre></div>
</div>
<p>Fonctionnement de l’image :</p>
<ul class="simple">
<li><p>La configuration NGINX de l’image est générée dynamiquement à son démarrage, à partir des variables d’environnement suivantes :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">NGINX_PORT</span></code> (défaut : 80)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NGINX_HOST</span></code> (défaut : localhost)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NGINX_LOCATION</span></code> (défaut : /, à modifier pour servir GeoNature sur un préfixe)</p></li>
</ul>
</li>
<li><p>La variable d’environnement <code class="docutils literal notranslate"><span class="pre">API_ENDPOINT</span></code> est lue au démarrage de l’image afin de mettre à jour le fichier de configuration du frontend <code class="docutils literal notranslate"><span class="pre">assets/config.json</span></code>.</p></li>
</ul>
</section>
</section>
<section id="https">
<h2>HTTPS<a class="headerlink" href="#https" title="Link to this heading"></a></h2>
<p>La procédure décrit une méthode de certification HTTPS de votre domaine, grâce au service <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a>. Les manipulations ont été effectuées sur un serveur Debian 9 avec Apache2 installé, et un utilisateur bénéficiant des droits sudo.</p>
<p>Cette documentation est indicative, car elle ne concerne pas GeoNature, mais la mise en place d’un certificat SSL pour une application web servie par Apache.</p>
<p>Ressources :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.memoinfo.fr/tutoriels-linux/configurer-lets-encrypt-apache/">https://www.memoinfo.fr/tutoriels-linux/configurer-lets-encrypt-apache/</a></p></li>
<li><p><a class="reference external" href="https://korben.info/securiser-facilement-gratuitement-site-https.html">https://korben.info/securiser-facilement-gratuitement-site-https.html</a></p></li>
</ul>
<section id="installer-certbot">
<h3>Installer certbot<a class="headerlink" href="#installer-certbot" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">certbot</span><span class="o">-</span><span class="n">apache</span>
</pre></div>
</div>
</section>
<section id="lancer-la-commande-cerbot">
<h3>Lancer la commande cerbot<a class="headerlink" href="#lancer-la-commande-cerbot" title="Link to this heading"></a></h3>
<p>Lancer la commande suivante pour générer des certificats et des clés pour le nom de domaine que vous souhaitez mettre en HTTPS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">certbot</span> <span class="o">--</span><span class="n">apache</span> <span class="o">--</span><span class="n">email</span> <span class="n">monemail</span><span class="nd">@mondomaine</span><span class="o">.</span><span class="n">fr</span>
</pre></div>
</div>
</section>
<section id="prise-en-compte-des-nouvelles-configurations-apache">
<h3>Prise en compte des nouvelles configurations Apache<a class="headerlink" href="#prise-en-compte-des-nouvelles-configurations-apache" title="Link to this heading"></a></h3>
<p>Activer les modules <code class="docutils literal notranslate"><span class="pre">ssl</span></code>, <code class="docutils literal notranslate"><span class="pre">headers</span></code> et <code class="docutils literal notranslate"><span class="pre">rewrite</span></code> puis redémarrer Apache :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">a2enmod</span> <span class="n">ssl</span>
<span class="n">sudo</span> <span class="n">a2enmod</span> <span class="n">rewrite</span>
<span class="n">sudo</span> <span class="n">a2enmod</span> <span class="n">headers</span>
<span class="n">sudo</span> <span class="n">apachectl</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Les fichiers de configuration des sites TaxHub et UsersHub ne sont pas à modifier, ils seront automatiquement associés à la configuration HTTPS. En revanche, la configuration de GeoNature doit être mise à jour.</p>
</section>
<section id="configuration-de-l-application-geonature">
<h3>Configuration de l’application GeoNature<a class="headerlink" href="#configuration-de-l-application-geonature" title="Link to this heading"></a></h3>
<p>Il est nécessaire de mettre à jour le fichier de configuration <code class="docutils literal notranslate"><span class="pre">geonature_config.toml</span></code> situé dans le répertoire <code class="docutils literal notranslate"><span class="pre">geonature/config</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">geonature</span><span class="o">/</span><span class="n">config</span>
<span class="n">nano</span> <span class="n">geonature_config</span><span class="o">.</span><span class="n">toml</span>
</pre></div>
</div>
<p>Modifier les éléments suivants :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">URL_APPLICATION</span> <span class="o">=</span> <span class="s1">&#39;https://mondomaine.fr/geonature&#39;</span>
<span class="n">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;https://mondomaine.fr/geonature/api&#39;</span>
<span class="n">API_TAXHUB</span> <span class="o">=</span> <span class="s1">&#39;https://mondomaine.fr/taxhub/api&#39;</span>
</pre></div>
</div>
<p>Pour que ces modifications soient prises en compte, exécuter les <a class="reference internal" href="admin-manual.html#post-config-change"><span class="std std-ref">actions à effecture après modification de la configuration</span></a>.</p>
<p>Les applications sont désormais accessibles sur votre domaine sécurisé en HTTPS !</p>
</section>
</section>
<section id="taches-planifiees">
<span id="cron"></span><h2>Taches planifiées<a class="headerlink" href="#taches-planifiees" title="Link to this heading"></a></h2>
<p>Depuis sa version 2.12.0, les taches planifiées gérées par des crons ont été remplacées par des taches lancées automatiquement par Celery Beat, pour être mis en place automatiquement lors de l’installation de GeoNature et être plus facilement administrables.</p>
</section>
<section id="installation-d-un-module-geonature">
<span id="install-gn-module"></span><h2>Installation d’un module GeoNature<a class="headerlink" href="#installation-d-un-module-geonature" title="Link to this heading"></a></h2>
<p>L’installation de GeoNature n’est livrée qu’avec les modules du coeur par défaut : Occtax, Occhab et Validation. Pour ajouter un module GeoNature externe, il est nécessaire de l’installer :</p>
<section id="telechargement">
<h3>Téléchargement<a class="headerlink" href="#telechargement" title="Link to this heading"></a></h3>
<p>Téléchargez le module depuis son dépôt Github puis dézippez-le dans le repertoire utilisateur, au même niveau que le dossier de GeoNature.</p>
</section>
<section id="installation-automatique">
<span id="install-gn-module-auto"></span><h3>Installation automatique<a class="headerlink" href="#installation-automatique" title="Link to this heading"></a></h3>
<p>Installation avec la sous-commande <code class="docutils literal notranslate"><span class="pre">install-gn-module</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>&lt;dossier<span class="w"> </span>GeoNature&gt;/backend/venv/bin/activate
geonature<span class="w"> </span>install-gn-module<span class="w"> </span>&lt;dossier<span class="w"> </span>du<span class="w"> </span>module&gt;<span class="w"> </span>&lt;code<span class="w"> </span>du<span class="w"> </span>module&gt;
</pre></div>
</div>
<p>Exemple pour le module Import :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>~/GeoNature/backend/venv/bin/activate
geonature<span class="w"> </span>install-gn-module<span class="w"> </span>~/gn_module_import/<span class="w"> </span>IMPORT
</pre></div>
</div>
<p>Puis relancer GeoNature et son worker :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>geonature
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>geonature-worker
</pre></div>
</div>
<p>Aucune permission n’est définie par défaut lors de l’installation d’un module. En tant qu’administrateur, vous pouvez exécuter une commande ajoutant tous les droits sur tous les modules à un groupe ou utilisateur. Cette commande peut être relancée après l’installation d’un module pour automatiquement attribuer toutes les permissions à un groupe ou utilisateur administrateur :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># changer &quot;Grp_Admin&quot; par le nom de votre groupe d&#39;administrateur si vous l&#39;avez changé</span>
geonature<span class="w"> </span>permissions<span class="w"> </span>supergrant<span class="w"> </span>--group<span class="w"> </span>--nom<span class="w"> </span><span class="s2">&quot;Grp_admin&quot;</span>
</pre></div>
</div>
<p>Vous devrez ensuite définir des droits à vos utilisateurs pour le nouveau module installé.</p>
</section>
<section id="installation-manuelle">
<h3>Installation manuelle<a class="headerlink" href="#installation-manuelle" title="Link to this heading"></a></h3>
<p><strong>Installation du backend</strong></p>
<p>Installer le module avec <code class="docutils literal notranslate"><span class="pre">pip</span></code> en mode éditable après avoir activé le venv de GeoNature, puis relancer GeoNature :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>~/geonature/backend/venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>--editable<span class="w"> </span>&lt;dossier<span class="w"> </span>du<span class="w"> </span>module&gt;
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>geonature
</pre></div>
</div>
<p id="module-install-frontend"><strong>Installation du frontend</strong></p>
<ul class="simple">
<li><p>Créer un lien symbolique dans le dossier <code class="docutils literal notranslate"><span class="pre">frontend/external_modules</span></code> de GeoNature vers le dossier <code class="docutils literal notranslate"><span class="pre">frontend</span></code> du module.
Le lien symbolique doit être nommé suivant le code du module en minuscule :</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/geonature/frontend/external_modules/
ln<span class="w"> </span>-s<span class="w"> </span>&lt;dossier<span class="w"> </span>du<span class="w"> </span>module&gt;/frontend<span class="w"> </span>&lt;code<span class="w"> </span>du<span class="w"> </span>module<span class="w"> </span>en<span class="w"> </span>minuscule&gt;
</pre></div>
</div>
<p>Exemple pour le module Import :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/geonature/frontend/external_modules/
ln<span class="w"> </span>-s<span class="w"> </span>~/gn_module_import/frontend<span class="w"> </span>import
</pre></div>
</div>
<ul class="simple">
<li><p>Re-builder le frontend :</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/geonature/frontend/
nvm<span class="w"> </span>use
npm<span class="w"> </span>run<span class="w"> </span>build
</pre></div>
</div>
<p><strong>Installation de la base de données</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>~/geonature/backend/venv/bin/activate
geonature<span class="w"> </span>upgrade-modules-db<span class="w"> </span>&lt;code<span class="w"> </span>du<span class="w"> </span>module&gt;
</pre></div>
</div>
</section>
<section id="configuration-du-module">
<span id="module-config"></span><h3>Configuration du module<a class="headerlink" href="#configuration-du-module" title="Link to this heading"></a></h3>
<p>De manière facultative, vous pouvez modifier la configuration du module.
Pour cela, vous pouvez créer un fichier de configuration dans le dossier <code class="docutils literal notranslate"><span class="pre">config</span></code> de GeoNature en le nommant <code class="docutils literal notranslate"><span class="pre">&lt;code</span> <span class="pre">du</span> <span class="pre">module</span> <span class="pre">en</span> <span class="pre">minuscule&gt;_config.toml</span></code>.
La plupart des modules fournissent un fichier d’exemple <code class="docutils literal notranslate"><span class="pre">&lt;module-code&gt;_config.toml.example</span></code> dans leur dossier racine dont vous pouvez vous inspirer.</p>
<p>Après création de ce fichier, activez le rechargement automatique de GeoNature lors des modifications du fichier en lançant les commandes suivantes :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>geonature
</pre></div>
</div>
<p>Avant la version 2.12.0 de GeoNature, après chaque modification de la configuration du module, vous devez recharger GeoNature manuellement :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>geonature
</pre></div>
</div>
</section>
<section id="mise-a-jour-du-module">
<h3>Mise à jour du module<a class="headerlink" href="#mise-a-jour-du-module" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Déplacer le code de l’ancienne version du module : <code class="docutils literal notranslate"><span class="pre">mv</span> <span class="pre">gn_module_xxx</span> <span class="pre">gn_module_xxx_old</span></code></p></li>
<li><p>Télécharger et désarchiver la nouvelle version du module, et renommer son dossier afin qu’il porte le même nom qu’avant (<em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">gn_module_xxx</span></code>)</p></li>
<li><p>(Optionnel) Si le fichier de configuration du module est encore placé avec celui-ci, le déplacer dans la dossier de configuration centralisée de GeoNature : <code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">gn_module_xxx_old/config/conf_gn_module.toml</span> <span class="pre">geonature/config/&lt;mode-code&gt;_config.toml</span></code></p></li>
<li><p>Relancer l’<a class="reference internal" href="#install-gn-module-auto"><span class="std std-ref">installation du module</span></a> : <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">install-gn-module</span> <span class="pre">gn_module_xxx</span> <span class="pre">XXX</span> <span class="pre">&amp;&amp;</span> <span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">reload</span> <span class="pre">geonature</span></code></p></li>
</ul>
</section>
</section>
<section id="mise-a-jour-de-l-application">
<h2>Mise à jour de l’application<a class="headerlink" href="#mise-a-jour-de-l-application" title="Link to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Avant chaque mise à jour de GeoNature, il est important de sauvegarder l’application et sa base de données, ou de faire un snapshot du serveur pour pouvoir revenir à son état antérieure avant mise à jour, en cas de problème.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Vérifiez préalablement la compatibilité des modules que vous utilisez avant de mettre GeoNature à jour.
S’il est nécessaire de les mettre à jour, arrêtez vous après le remplacement du dossier par le nouveau code source
(et la récupération éventuelle de la configuration) ; le script de migration de GeoNature s’occupera automatiquement
d’installer la nouvelle version du module.</p>
</div>
<p>La mise à jour de GeoNature consiste à télécharger sa nouvelle version dans un nouveau répertoire, récupérer les fichiers de configuration et de surcouche, ainsi que les médias depuis la version actuelle et de relancer l’installation dans le répertoire de la nouvelle version.</p>
<p>La mise à jour doit être réalisée avec votre utilisateur linux courant (<code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code> par exemple) et non pas le super-utilisateur <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<ul>
<li><p>Télécharger la dernière version de GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">GeoNature</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">rm</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</li>
<li><p>Renommer l’ancien repertoire de l’application, ainsi que le nouveau :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="o">~/</span><span class="n">geonature</span><span class="o">/</span> <span class="o">~/</span><span class="n">geonature_old</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">~/</span><span class="n">GeoNature</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span> <span class="o">~/</span><span class="n">geonature</span><span class="o">/</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">geonature</span>
</pre></div>
</div>
</li>
<li><p>Suivez les éventuelles notes de version spécifiques décrites au niveau de chaque version : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/releases">https://github.com/PnX-SI/GeoNature/releases</a>.</p></li>
</ul>
<p>Sauf mentions contraires dans les notes de version, vous pouvez sauter des versions mais en suivant bien les différentes notes de versions intermédiaires.</p>
<ul>
<li><p>Si vous devez aussi mettre à jour TaxHub et/ou UsersHub, suivez leurs notes de versions mais aussi leur documentation (<a class="reference external" href="https://usershub.readthedocs.io">https://usershub.readthedocs.io</a> et <a class="reference external" href="https://taxhub.readthedocs.io">https://taxhub.readthedocs.io</a>).</p></li>
<li><p>Lancez le script de <code class="docutils literal notranslate"><span class="pre">migration.sh</span></code> à la racine du dossier <code class="docutils literal notranslate"><span class="pre">geonature</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">install</span><span class="o">/</span><span class="n">migration</span><span class="o">/</span><span class="n">migration</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
</ul>
<p>Depuis la version 2.12, le script <cite>migration.sh</cite> peut prendre en argument le chemin vers l’ancien dossier d’installation de GeoNature. Il peut s’agir du même dossier que la nouvelle installation de GeoNature. Cela permet d’utiliser ce script si la nouvelle version de GeoNature est dans le même dossier et donc de gérer le cas où GeoNature est installé et mis à jour avec git.</p>
<p>Dans ce cas, les commandes à exécuter sont :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">GeoNature</span>
<span class="n">git</span> <span class="n">status</span> <span class="c1"># optionnel, pour connaitre l&#39;état et la version ou branche actuellement utilisée</span>
<span class="n">git</span> <span class="n">fetch</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span> <span class="c1"># où X.Y.Z est le numéro du tag de la version vers laquelle faire la mise à jour, ou le nom de la branche à utiliser</span>
<span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span> <span class="c1"># ou &quot;git config submodule.recurse true&quot; lancé une seule fois, pour que la mise à jour des sous-modules soit relancée automatiquement à chaque git pull</span>
<span class="o">./</span><span class="n">install</span><span class="o">/</span><span class="n">migration</span><span class="o">/</span><span class="n">migration</span><span class="o">.</span><span class="n">sh</span> <span class="o">.</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="index.html" class="btn btn-neutral float-left" title="Bienvenue dans la documentation de GeoNature" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="user-manual.html" class="btn btn-neutral float-right" title="MANUEL UTILISATEUR" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2018-2023, PnE, PnC.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>